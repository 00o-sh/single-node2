apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: kopia-maintenance-nfs
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE","UPDATE"]
        resources: ["jobs"]
  matchConditions:
    # Only VolSync Kopia maintenance jobs
    - name: is-volsync-kopia-maintenance
      expression: has(object.metadata.labels["volsync.backube/type"]) &&
                  object.metadata.labels["volsync.backube/type"] == "kopia-maintenance"

    # Only if 'repository' volume is not already present
    - name: repository-volume-absent
      expression: !has(object.spec.template.spec.volumes) ||
                  !object.spec.template.spec.volumes.exists(v, v.name == "repository")
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >-
          [
            // Ensure volumes array exists
            JSONPatch{
              op: has(object.spec.template.spec.volumes) ? "test" : "add",
              path: "/spec/template/spec/volumes",
              value: has(object.spec.template.spec.volumes) ? object.spec.template.spec.volumes : []
            },

            // Add the NFS volume
            JSONPatch{
              op: "add",
              path: "/spec/template/spec/volumes/-",
              value: {
                "name": "repository",
                "nfs": {
                  "server": "nas.3226texas.com",
                  "path": "/mnt/Speed/VolsyncKopia"
                }
              }
            },

            // Ensure volumeMounts array exists for container 0
            JSONPatch{
              op: has(object.spec.template.spec.containers[0].volumeMounts) ? "test" : "add",
              path: "/spec/template/spec/containers/0/volumeMounts",
              value: has(object.spec.template.spec.containers[0].volumeMounts) ? object.spec.template.spec.containers[0].volumeMounts : []
            },

            // Add the mount
            JSONPatch{
              op: "add",
              path: "/spec/template/spec/containers/0/volumeMounts/-",
              value: {
                "name": "repository",
                "mountPath": "/repository"
              }
            }
          ]
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: kopia-maintenance-nfs
spec:
  policyName: kopia-maintenance-nfs
